# Create your views here.
from ebserv.lib import dictionaries
from django.views.decorators.http import require_POST
from forms import SearchForm
from django.shortcuts import render_to_response

DICTIONARY_DIRECTORY = '/home/alex/dictionaries/'


def search(request): #default should be 'all'
  book_name='chujiten'
  #todo:book_name validation, search_method validation etc
  #TODO html rendering if not ajax
  
  if request.method == 'POST':
    dictionaries.initialize()
    
    search_dict = dictionaries.EpwingDictionary('{0}/{1}'.format(DICTIONARY_DIRECTORY, book_name))
    results = []
    for heading, content, uri_key in search_dict.search(request.POST['query'], request.POST['search_method']):
      results.append({ 'URI': '/dict/{0}/entry/{1}/'.format(book_name, uri_key),
                       'heading': heading })
    
    dictionaries.finalize()
  
    ret = { 'results': results }
            
    if request.is_ajax():
      return HttpResponse(simplejson.dumps(ret))
    else:
      return render_to_response('restful_dictionary/search_results.html', ret)
  else:
    form = SearchForm()
    return render_to_response('restful_dictionary/search_form.html', { 'form': form })
